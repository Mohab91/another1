<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>تسجيل حضور التدريب</title>
  <style>
    body { font-family: 'Arial', sans-serif; text-align: center; margin-top: 50px; background-color: #f9f9f9; direction: rtl; }
    input, select { padding: 10px; margin: 10px; width: 80%; font-size: 16px; }
    button { padding: 10px 20px; font-size: 16px; }
  </style>
</head>
<body>
  <h2>نموذج تسجيل الحضور</h2>
  <input type="text" id="name" placeholder="الاسم" required />
  <input type="text" id="nid" placeholder="الرقم القومي" required />
  <input type="text" id="niaba" placeholder="النيابة" required />
  <br>
  <button id="submitBtn" disabled>تسجيل الحضور</button>
  <p id="status">جاري التحقق من موقعك...</p>

  <script>
    const submitBtn = document.getElementById("submitBtn");
    const statusEl = document.getElementById("status");
    const scriptUrl = "https://script.google.com/macros/s/AKfycbwURU959SeKzxljKGa_NW-Ry7b3bAZLyZx7lVQRJRmcGVv-MFZOUzo89FZ6Z-_4HZnJfw/exec";

    const allowedLat = 30.0656648;
    const allowedLon = 31.2081144;
    const maxDist = 500;

    function toRad(x) { return x * Math.PI / 180; }
    function getDistance(lat1, lon1, lat2, lon2) {
      const R = 6371000;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat/2) ** 2 +
                Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                Math.sin(dLon/2) ** 2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    navigator.geolocation.getCurrentPosition(pos => {
      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;
      const dist = getDistance(lat, lon, allowedLat, allowedLon);

      if (dist <= maxDist) {
        statusEl.textContent = "✅ يمكنك الآن تسجيل الحضور.";
        submitBtn.disabled = false;

        submitBtn.onclick = () => {
          const name = document.getElementById("name").value.trim();
          const nid = document.getElementById("nid").value.trim();
          const niaba = document.getElementById("niaba").value.trim();

          if (!name || !nid || !niaba) {
            alert("يرجى ملء جميع البيانات");
            return;
          }

          fetch(scriptUrl, {
            method: "POST",
            body: JSON.stringify({ name, nid, niaba, lat, lon }),
            headers: { "Content-Type": "application/json" },
          })
          .then(res => res.json())
          .then(data => {
            statusEl.textContent = data.result;
            submitBtn.disabled = true;
          });
        };
      } else {
        statusEl.textContent = `❌ أنت بعيد جدًا (${Math.round(dist)} متر). لا يمكن تسجيل الحضور.`;
      }
    }, () => {
      statusEl.textContent = "❌ لم يتم السماح بالوصول إلى الموقع.";
    });
  </script>
</body>
</html>
